# 1.0 Runtime Semantics — Deterministic Agent Runtime

本文档描述 Aetheris 1.0 的**最小运行时语义**：从「可恢复的 agent」升级为「可信执行的 agent」—— Replay 不再触发真实外部调用，且当外部世界与记录不一致时可拒绝信任已提交结果。

## 目标

- **Execution replay（旧）**：程序恢复到某一步，但现实世界可能已被再次修改。
- **World-consistent replay（1.0）**：Event → 校验外部世界 → 恢复内存 → 跳过执行（Execution Permission）。

实现该闭环需要三个机制，均在代码中已实现；本文档说明语义并指向关键文件。

---

## ① Tool Invocation Ledger（工具调用账本）

**语义**：每一次工具调用是持久实体；Runner 执行 step 时先查 invocation，若已有成功记录则返回结果、**禁止再次调用 tool**；否则创建记录、执行、写结果并提交。

**关键文件**：

- [internal/agent/runtime/executor/invocation_store.go](internal/agent/runtime/executor/invocation_store.go)：`ToolInvocationRecord`（InvocationID, JobID, StepID, ToolName, ArgsHash, IdempotencyKey, Status, Result, Committed）；Store 接口 `GetByJobAndIdempotencyKey`、`SetStarted`、`SetFinished`。
- [internal/agent/runtime/executor/node_adapter.go](internal/agent/runtime/executor/node_adapter.go)：执行前 `GetByJobAndIdempotencyKey`；若 `Committed && Status == success` 则先做 Confirmation（见③）再注入 Result 并 return，不执行 tool；否则 `SetStarted` → 执行 → `SetFinished(..., committed=true)`，事件在 store 更新之后写入。
- [internal/agent/replay/replay.go](internal/agent/replay/replay.go)：`tool_invocation_finished`（outcome success）→ `CompletedToolInvocations[idempotency_key] = result`，Replay 路径可从事件流注入结果而无需 store。

**结论**：当存在已提交成功记录（store 或事件构建的 CompletedToolInvocations）时，replay **不会**触发真实 tool 调用。

**多 Worker**：内存 store 仅单进程有效；多 Worker 需共享 `ToolInvocationStore`（如 PostgreSQL）。可选实现见 [internal/agent/runtime/executor/invocation_pg.go](internal/agent/runtime/executor/invocation_pg.go)；API/Worker 在 `jobstore.type=postgres` 时自动使用 PG 账本。可选状态 `confirmed`：Confirmation 通过后可将记录置为 `ToolInvocationStatusConfirmed`，供审计或策略「已 confirmed 则跳过校验」使用（见 [invocation_store.go](internal/agent/runtime/executor/invocation_store.go)）。

---

## ② StepOutcome 世界语义

**语义**：Step 结果不仅表示「程序是否成功」，还表示「世界是否被改变」。Replay 与 Scheduler 根据 outcome 决定是否重试、是否视为完成。

**结果类型**：

| 类型 | 含义 |
|------|------|
| success | 无副作用完成（如 LLM 步） |
| side_effect_committed | 外部世界已改变（tool 步成功） |
| retryable_failure | 可重试 |
| permanent_failure | 逻辑失败 |
| compensatable_failure | 部分提交，待补偿 |
| compensated | 已回滚，视为终态 |

**关键文件**：

- [internal/agent/runtime/executor/runner.go](internal/agent/runtime/executor/runner.go)：`StepResultSideEffectCommitted`、`StepResultCompensated` 等；成功 **tool** 步记为 `side_effect_committed`。
- [internal/agent/replay/replay.go](internal/agent/replay/replay.go)：`result_type` 为 `""`、`success`、`side_effect_committed`、`compensated` 时节点视为完成。
- [internal/agent/job/scheduler.go](internal/agent/job/scheduler.go)：不对 `SideEffectCommitted`、`Compensated` 重试。

TraceUI 与事件流可将 `side_effect_committed` 视为「外部世界已改变」用于审计。

---

## ③ Confirmation Replay（确认式重放）

**语义**：Replay 不是「再执行一次 step」，而是「校验外部状态 → 恢复内存 → 跳过执行」。当 StepOutcome = SideEffectCommitted 时：查 ToolInvocation、查 StateChanged、**验证资源仍存在**、恢复上下文、**跳过执行**。

**关键文件**：

- [internal/agent/runtime/executor/state_diff.go](internal/agent/runtime/executor/state_diff.go)：`ResourceVerifier` 接口 `Verify(ctx, jobID, stepID, resourceType, resourceID, operation, externalRef) (ok bool, err error)`；`StateChanged` 含 Version、Etag、ExternalRef 供审计与校验。
- [internal/agent/replay/replay.go](internal/agent/replay/replay.go)：`state_changed` 事件 → `StateChangesByStep[node_id]`；ReplayContext 携带 `StateChangesByStep` 与 `CompletedToolInvocations`。
- [internal/agent/runtime/executor/runner.go](internal/agent/runtime/executor/runner.go)：当 `replayCtx != nil` 时，将 `CompletedToolInvocations` 与 `StateChangesByStep`（转为 `StateChangeForVerify`）注入 context，再调用 `step.Run`。
- [internal/agent/runtime/executor/node_adapter.go](internal/agent/runtime/executor/node_adapter.go)：在从 **InvocationStore** 或 **CompletedToolInvocations** 注入前调用 `runConfirmation(ctx, jobID, taskID, stepChanges)`；若配置了 `ResourceVerifier` 且本步有 StateChanged 记录，则对每条调用 `Verify`；任一条 `ok==false` 或 `err!=nil` 则返回**永久失败**（job 失败，不静默重执行）。仅当校验通过或无可校验项时才注入结果。

**结论**：Replay 路径 = 有校验项时先 verify，再恢复内存并跳过执行；校验失败则拒绝信任、job 失败。

**生产**：应用与 Worker 当前传入 `resourceVerifier = nil`，因此默认不执行具体校验。需至少一个具体 `ResourceVerifier` 实现（如 GitHub：校验 issue 仍存在）并在 bootstrap 中挂载，才能使「校验外部世界」非 no-op。见 [internal/agent/runtime/executor/verifier/github.go](internal/agent/runtime/executor/verifier/github.go)。

---

## 小结

| 机制 | 语义 | 实现位置 |
|------|------|----------|
| ① Tool Invocation Ledger | 先查再执行，提交后 replay 不执行 | invocation_store.go, node_adapter.go, replay.go |
| ② StepOutcome 世界语义 | success / side_effect_committed / compensated 等 | runner.go, replay.go, scheduler.go |
| ③ Confirmation Replay | 注入前 Verify；失败则 job 失败 | state_diff.go, node_adapter runConfirmation, runner 注入 StateChangesByStep |

完成上述三点后，Aetheris 具备**最小运行时语义**：replay 不再触发外部调用，且当外部世界与记录不一致时可拒绝信任已提交结果，即「可信执行的 agent」而非仅「可恢复的 agent」。
