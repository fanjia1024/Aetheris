# API 服务配置
api:
  port: 8080
  host: "0.0.0.0"
  timeout: 30s
  cors:
    enable: true
    allow_origins: ["*"]
  middleware:
    auth: false
    rate_limit: true
    rate_limit_rps: 100
    # JWT（auth 为 true 时生效）；jwt_key 建议用环境变量 "${JWT_SECRET}"
    jwt_key: ""
    jwt_timeout: "1h"
    jwt_max_refresh: "1h"
  # 取证查询类接口开关（默认关闭，避免暴露实验能力）
  forensics:
    experimental: false
  grpc:
    enable: false
    port: 9090

# Rate Limiting & Backpressure (2.0 scalability features)
rate_limits:
  # Tool 维度限流：每个 tool 独立配置 QPS 和并发限制
  tools:
    github_create_issue:
      qps: 10
      max_concurrent: 5
    stripe_create_payment:
      qps: 100
      max_concurrent: 20
    # 默认配置（未明确配置的 tool 使用此配置）
    _default:
      qps: 100
      max_concurrent: 10
  
  # LLM Provider 限流：支持 token budget
  llm:
    openai:
      tokens_per_minute: 90000
      requests_per_minute: 3500
      max_concurrent: 50
    anthropic:
      tokens_per_minute: 100000
      requests_per_minute: 4000
      max_concurrent: 50
    _default:
      tokens_per_minute: 90000
      requests_per_minute: 3500
      max_concurrent: 50

# 任务事件存储（事件流 + 租约）；未配置或 type 非 postgres 时使用内存后端
# 当 type=postgres 时，仅由 Worker 进程通过事件 Claim 执行，API 不启动进程内 Scheduler（单一执行权）
# 本地 Docker 启动 Postgres 并初始化表结构：
#   docker run -d --name aetheris-pg -p 5432:5432 \
#     -e POSTGRES_USER=aetheris -e POSTGRES_PASSWORD=aetheris -e POSTGRES_DB=aetheris \
#     -v $(pwd)/internal/runtime/jobstore/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro \
#     postgres:15-alpine
# 或使用项目 compose：docker compose -f deployments/compose/docker-compose.yml up -d postgres
jobstore:
  type: "postgres"         # memory | postgres
  dsn: "postgres://aetheris:aetheris@localhost:5432/aetheris?sslmode=disable"  # 可用环境变量 JOBSTORE_DSN 覆盖
  lease_duration: "30s"    # 租约时长；Heartbeat 间隔建议 < lease_duration/2

# v1 Agent 与 Job 调度（仅 jobstore.type=memory 时生效；postgres 时 API 不拉取，由 Worker 唯一执行）
agent:
  job_scheduler:
    enabled: true        # 仅内存模式有效；postgres 时强制不启 API Scheduler
    max_concurrency: 2   # 最大并发执行 Job 数
    retry_max: 2       # 失败后最大重试次数（不含首次）
    backoff: "1s"      # 重试前等待时间
  # Eino ADK 主 Runner：未配置或 enabled 不为 false 时，POST /api/agent/run、/api/agent/resume、/api/agent/stream 使用 ADK 执行
  adk:
    # enabled: true     # 设为 false 时禁用 ADK，改用原 Plan→Execute Agent
    checkpoint_store: "memory"   # 内存；后续可扩展 postgres/redis

# 存储配置（与 worker 对齐；API 单机时也用于 ingest/query 的向量与元数据）
storage:
  metadata:
    type: "memory"
    dsn: ""
    pool_size: 0
  # 向量库：type=memory 为内置内存；type=redis 使用 eino-ext Redis Indexer/Retriever（需 Redis Stack，并预先创建向量索引）
  # collection 为默认索引/集合名，ingest 与 query 共用
  vector:
    type: "memory"
    addr: ""
    db: ""
    collection: "default"
    password: ""   # Redis 时可选
  # Redis 示例（需 Redis Stack 并预先创建向量索引）：
  # vector:
  #   type: "redis"
  #   addr: "localhost:6379"
  #   db: "0"
  #   collection: "default"
  #   password: ""
  object:
    type: "memory"
  cache:
    type: "memory"
  # 入库管线可选：batch_size/concurrency 未配置时使用默认 100/4
  ingest:
    batch_size: 100
    concurrency: 4

# 服务发现
service:
  agent_service:
    addr: "localhost:9090"
    timeout: 10s
  index_service:
    addr: "localhost:9091"
    timeout: 30s

# 日志配置
log:
  level: "info"
  format: "json"
  file: ""

# 监控配置
monitoring:
  prometheus:
    enable: true
    port: 9092
  # 链路追踪（OpenTelemetry），未配置 endpoint 时可使用环境变量 OTEL_EXPORTER_OTLP_ENDPOINT
  tracing:
    enable: false
    service_name: "rag-api"
    export_endpoint: ""   # 如 "localhost:4317"
    insecure: true
