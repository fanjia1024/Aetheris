# Aetheris 2.x å·¥ç¨‹æ‹†è§£ â†’ ä»£ç æ˜ å°„

## æ€»è§ˆ

åŸºäº CTO çº§å·¥ç¨‹æ‹†è§£ï¼Œå°† 2.1-2.5 çš„éœ€æ±‚ç²¾ç¡®æ˜ å°„åˆ°ç°æœ‰ repo ç»“æ„ï¼Œæ ‡æ³¨å“ªäº›å·²æœ‰ã€å“ªäº›éœ€è¦è¡¥å……ã€‚

---

## A. Evidence Export APIï¼ˆ2.1ï¼‰- ç°æœ‰ä»£ç æ˜ å°„

### A1. è¯æ®åŒ…å¯¼å‡ºæœåŠ¡åŒ–

#### âœ… å·²æœ‰å®ç°

**æ ¸å¿ƒåº“**ï¼š
- `pkg/proof/export.go:28-184` - `ExportEvidenceZip()` å®Œæ•´å®ç°
  - æ¥å— `JobStore` å’Œ `Ledger` æ¥å£
  - ç”Ÿæˆ ZIPï¼ˆmanifest + events.ndjson + ledger.ndjson + proof.json + metadata.jsonï¼‰
  - è®¡ç®—æ–‡ä»¶å“ˆå¸Œ

**API Handler**ï¼š
- `internal/api/http/forensics.go:34-77` - `ExportJobForensics()` 
  - `POST /api/jobs/:id/export`
  - è°ƒç”¨ `buildForensicsPackage()`
  - è¿”å› ZIP æ•°æ®

**é€‚é…å™¨**ï¼š
- `internal/api/http/forensics.go:84-131` - `proofJobStoreAdapter`
  - å°† `jobstore.JobStore` é€‚é…ä¸º `proof.JobStore`
- `internal/api/http/forensics.go:133-256` - `proofLedgerAdapter`
  - ä»äº‹ä»¶æµé‡å»º ledgerï¼ˆå½“å‰å®ç°ï¼‰

**CLI**ï¼š
- `cmd/cli/main.go:765-795` - `runExport()` è°ƒç”¨ API

#### ğŸ”§ éœ€è¦è¡¥å……

**1. Ledger é€‚é…å™¨æ”¹è¿›**ï¼ˆPR#1 å·²å®Œæˆ âœ…ï¼‰
- æ–‡ä»¶ï¼š`internal/agent/runtime/executor/invocation_pg.go`
- å·²æ·»åŠ ï¼š`ListByJobID()` æ–¹æ³•
- ç”¨é€”ï¼šç›´æ¥æŸ¥è¯¢ `tool_invocations` è¡¨ï¼Œä¸ä»äº‹ä»¶æµé‡å»º

**2. æµå¼å¯¼å‡º**ï¼ˆè®¾è®¡å®Œæˆï¼Œå¾…å®ç°ï¼‰
- ä¿®æ”¹ï¼š`internal/api/http/forensics.go:ExportJobForensics()`
- æ–¹æ¡ˆï¼šä½¿ç”¨ `io.Pipe` + goroutine
- é¿å…ï¼šå¤§ job å†…å­˜æº¢å‡º

**3. å¯¼å‡ºé…ç½®**ï¼ˆè®¾è®¡å®Œæˆï¼Œå¾…å®ç°ï¼‰
- æ–°å»ºï¼š`pkg/config/evidence.go`
- åŠ è½½ï¼š`configs/api.yaml` ä¸­çš„ evidence é…ç½®
- é›†æˆï¼šHandler åˆå§‹åŒ–æ—¶ä¼ å…¥

---

### A2. ç¦»çº¿éªŒè¯å™¨äº§å“åŒ–

#### âœ… å·²æœ‰å®ç°

**æ ¸å¿ƒåº“**ï¼š
- `pkg/proof/verify.go:157-197` - `ValidateLedgerConsistency()`
- `pkg/proof/verify.go:30-116` - `VerifyEvidenceZip()`
- `pkg/proof/hash.go:40-74` - `ValidateChain()`

**æµ‹è¯•**ï¼š
- `pkg/proof/verify_test.go` - 9 ä¸ªæµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰
  - æ­£å¸¸éªŒè¯ã€ç¯¡æ”¹æ£€æµ‹ã€åˆ é™¤æ£€æµ‹ã€Ledger ä¸ä¸€è‡´

**CLI**ï¼š
- `cmd/cli/main.go:796-816` - `runVerify()` ç®€åŒ–ç‰ˆ

#### ğŸ”§ éœ€è¦è¡¥å……

**1. CLI å®Œæ•´å®ç°**ï¼ˆPR#2 è®¾è®¡å®Œæˆï¼Œå¾…å®ç°ï¼‰
- ä¿®æ”¹ï¼š`cmd/cli/main.go:runVerify()`
- æ”¹ä¸ºï¼šçœŸæ­£è°ƒç”¨ `proof.VerifyEvidenceZip()`
- è¾“å‡ºï¼šç»“æ„åŒ–ç»“æœï¼ˆJSON + äººç±»å¯è¯»ï¼‰

**2. éªŒè¯ç»“æœè¯¦ç»†åŒ–**
- æ‰©å±•ï¼š`pkg/proof/types.go:VerifyResult`
- å¢åŠ ï¼šå…·ä½“é”™è¯¯ä½ç½®ã€å»ºè®®ä¿®å¤

---

### A3. Ledger ä¸€è‡´æ€§æ ¡éªŒå¢å¼º

#### âœ… å·²æœ‰åŸºç¡€

**å½“å‰å®ç°**ï¼š
- `pkg/proof/verify.go:157-197` - `ValidateLedgerConsistency()`
  - æ£€æŸ¥ finished äº‹ä»¶åœ¨ ledger ä¸­å­˜åœ¨
  - æ£€æŸ¥ ledger committed è®°å½•æœ‰ finished äº‹ä»¶
  - æ£€æŸ¥ tool_name ä¸€è‡´æ€§

#### ğŸ”§ éœ€è¦è¡¥å……

**ä¸¥æ ¼æ ¡éªŒè§„åˆ™**ï¼ˆPR#6 è®¾è®¡å®Œæˆï¼Œå¾…å®ç°ï¼‰ï¼š
1. éªŒè¯ output hash ä¸€è‡´ï¼ˆå¦‚æœæœ‰ï¼‰
2. éªŒè¯çŠ¶æ€æœºï¼ˆstarted â†’ finishedï¼Œä¸èƒ½è·³ï¼‰
3. éªŒè¯ idempotency_key ä¸¥æ ¼å¯¹åº”
4. è¿”å›è¯¦ç»†é”™è¯¯ï¼ˆå“ªä¸ª invocation_id ä¸ä¸€è‡´ï¼‰

**ä½ç½®**ï¼š`pkg/proof/verify.go:ValidateLedgerConsistency()`

---

## B. Evidence Graphï¼ˆ2.2ï¼‰- ç°æœ‰ä»£ç æ˜ å°„

### B1. Artifact Storeï¼ˆåˆ¶å“å­˜å‚¨ï¼‰

#### âœ… å·²æœ‰ç›¸å…³

**Checkpoint**ï¼š
- `internal/agent/runtime/checkpoint.go:21-28` - `Checkpoint` ç»“æ„
  - åŒ…å«ï¼šTaskGraphState, MemoryState, PayloadResults
- `internal/agent/runtime/checkpoint.go:30-39` - `CheckpointStore` æ¥å£

**Reasoning Snapshot**ï¼š
- `internal/runtime/jobstore/event.go:73` - `ReasoningSnapshot` äº‹ä»¶ç±»å‹
- Payload åŒ…å«ï¼ševidence å­—æ®µï¼ˆrag_doc_ids, tool_invocation_ids, llm_decisionï¼‰

#### ğŸ†• éœ€è¦æ–°å¢

**1. Artifact è¡¨**ï¼ˆschemaï¼‰ï¼š
```sql
CREATE TABLE IF NOT EXISTS artifacts (
    artifact_id    TEXT PRIMARY KEY,
    job_id         TEXT NOT NULL,
    type           TEXT NOT NULL,  -- llm_output | tool_output | rag_doc | file
    sha256         TEXT NOT NULL,
    uri            TEXT,
    metadata_json  JSONB,
    created_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX idx_artifacts_job_id ON artifacts (job_id);
CREATE INDEX idx_artifacts_type ON artifacts (job_id, type);
```

**2. Artifact åŒ…**ï¼š
- æ–°å»ºï¼š`pkg/artifacts/store.go`
  - `type ArtifactStore interface { Put, Get, List }`
- æ–°å»ºï¼š`pkg/artifacts/types.go`
  - `type Artifact struct { ID, JobID, Type, SHA256, URI, Metadata }`

**3. Runner é›†æˆ**ï¼š
- ä¿®æ”¹ï¼š`internal/agent/runtime/executor/runner.go`
  - Tool å®Œæˆåï¼š`artifactStore.Put(ctx, ToolOutputArtifact{...})`
  - LLM å®Œæˆåï¼š`artifactStore.Put(ctx, LLMOutputArtifact{...})`

---

### B2. Causal Edgeï¼ˆå› æœè¾¹ï¼‰

#### âœ… å·²æœ‰ç›¸å…³

**Evidence Graph Builder**ï¼š
- `pkg/evidence/builder.go:29-76` - `BuildFromEvents()`
  - è§£æ reasoning_snapshot
  - æå– input_keys å’Œ output_keys
  - æ„å»ºä¾èµ–è¾¹ï¼ˆæ¨å¯¼æ¨¡å¼ï¼‰

**æ•°æ®ç»“æ„**ï¼š
- `pkg/evidence/types.go:66-78` - `GraphEdge`
  - From, To, Relation, DataKey

#### ğŸ†• éœ€è¦æ–°å¢ï¼ˆå¦‚æœé€‰æ‹©å­˜å‚¨æ¨¡å¼ï¼‰

**1. Causal Edge è¡¨**ï¼ˆå¯é€‰ï¼Œæ¨å¯¼æ¨¡å¼ä¸éœ€è¦ï¼‰ï¼š
```sql
CREATE TABLE IF NOT EXISTS causal_edges (
    edge_id     TEXT PRIMARY KEY,
    job_id      TEXT NOT NULL,
    from_type   TEXT NOT NULL,  -- event | node | artifact
    from_id     TEXT NOT NULL,
    to_type     TEXT NOT NULL,
    to_id       TEXT NOT NULL,
    kind        TEXT NOT NULL,  -- consumes | produces | causes | justifies
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX idx_causal_edges_job_id ON causal_edges (job_id);
```

**2. Edge Store**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
- æ–°å»ºï¼š`pkg/evidencegraph/edge_store.go`
  - `type EdgeStore interface { Append, List, BuildGraph }`

**æ¨èç­–ç•¥**ï¼š2.2 å…ˆç”¨**æ¨å¯¼æ¨¡å¼**ï¼ˆä» events æ¨å¯¼ï¼‰ï¼Œä¸å»ºè¡¨ã€‚
  - ç°æœ‰ `pkg/evidence/builder.go` å·²è¶³å¤Ÿ
  - æ€§èƒ½è¶³å¤Ÿåå†è€ƒè™‘ç‰©åŒ–å­˜å‚¨

---

### B3. Decision Markersï¼ˆå…³é”®å†³ç­–ç‚¹ï¼‰

#### âœ… å·²æœ‰ç›¸å…³

**äº‹ä»¶ç±»å‹**ï¼š
- `internal/runtime/jobstore/event.go:87-90` - M3 å·²æ·»åŠ ï¼š
  - `CriticalDecisionMade`
  - `HumanApprovalGiven`
  - `PaymentExecuted`
  - `EmailSent`

#### ğŸ”§ éœ€è¦è¡¥å……

**1. Marker å†™å…¥æ¥å£**ï¼š
- æ–°å»ºï¼š`pkg/decisions/marker.go`
  - `type DecisionMarker struct { Type, PolicyID, EvidenceRefs, HumanActor }`
  - `func EmitDecision(ctx, marker) error`

**2. Runner/Tool é›†æˆ**ï¼š
- ä¿®æ”¹ï¼šTool adapter åœ¨å…³é”®æ“ä½œï¼ˆpayment/email/approvalï¼‰å
  - å¯é€‰è°ƒç”¨ `EmitDecision()`

---

## C. Forensics Queryï¼ˆ2.3ï¼‰- ç°æœ‰ä»£ç æ˜ å°„

### C1. Job Index ç´¢å¼•å±‚

#### âœ… å·²æœ‰ç›¸å…³

**Job å…ƒæ•°æ®è¡¨**ï¼š
- `internal/runtime/jobstore/schema.sql:30-59` - `jobs` è¡¨
  - å·²æœ‰ï¼šid, agent_id, goal, status, cursor, retry_count, created_at, updated_at

#### ğŸ†• éœ€è¦æ–°å¢

**1. Job Index è¡¨æ‰©å±•**ï¼š
```sql
-- æ‰©å±• jobs è¡¨æˆ–æ–°å»º job_index è¡¨
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS last_tool TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS model_versions TEXT[];  -- æˆ– JSON
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS decision_kinds TEXT[];

CREATE INDEX IF NOT EXISTS idx_jobs_last_tool ON jobs (last_tool);
CREATE INDEX IF NOT EXISTS idx_jobs_created_at ON jobs (created_at);
```

**2. Indexer å®ç°**ï¼š
- æ–°å»ºï¼š`internal/indexer/job_indexer.go`
  - `type JobIndexer struct { jobStore }`
  - `func (i *JobIndexer) ApplyEvent(event) error`
  - åœ¨äº‹ä»¶å†™å…¥æ—¶æˆ–åå°ä»»åŠ¡ä¸­æ›´æ–°ç´¢å¼•

---

### C2. Forensics Query API

#### âœ… å·²æœ‰æ¡†æ¶

**API Endpoints**ï¼š
- `internal/api/http/forensics_query.go:60-100` - `ForensicsQuery()`
  - `POST /api/forensics/query`
- `internal/api/http/forensics_query.go:188-252` - `ForensicsBatchExport()`
- `internal/api/http/forensics_query.go:272-307` - `ForensicsConsistencyCheck()`

**Query Engine**ï¼š
- `pkg/forensics/query_engine.go:28-44` - `Query()` æ¡†æ¶
- `pkg/forensics/types.go:18-42` - `QueryRequest` æ•°æ®ç»“æ„

#### ğŸ”§ éœ€è¦è¡¥å……

**1. Query Engine å®ç°**ï¼š
- ä¿®æ”¹ï¼š`pkg/forensics/query_engine.go`
  - è¿æ¥ job store å’Œ job index
  - å®ç°è¿‡æ»¤é€»è¾‘ï¼ˆtime_range, tool_filter, event_filterï¼‰
  - åˆ†é¡µæ”¯æŒ

**2. æ‰¹é‡å¯¼å‡ºä»»åŠ¡é˜Ÿåˆ—**ï¼š
- æ–°å»ºï¼š`internal/forensics/export_task.go`
  - `type ExportTaskQueue interface { Enqueue, GetStatus, GetResult }`
  - å¼‚æ­¥å¤„ç†å¤§é‡ jobs å¯¼å‡º

**3. ç´¢å¼•ä¼˜åŒ–**ï¼š
```sql
CREATE INDEX idx_tool_invocations_tool_time ON tool_invocations (tool_name, created_at);
CREATE INDEX idx_jobs_status_created ON jobs (status, created_at);
```

---

### C3. å–è¯æŠ¥å‘Šç”Ÿæˆ

#### ğŸ†• éœ€è¦æ–°å¢

**1. Report Generator**ï¼š
- æ–°å»ºï¼š`internal/forensics/report/generator.go`
  - `func GenerateReport(ctx, jobID, format) ([]byte, error)`
  - æ”¯æŒï¼šmarkdown, json, pdfï¼ˆå¯é€‰ï¼‰

**2. API Endpoint**ï¼š
- æ–°å¢ï¼š`GET /api/forensics/jobs/:id/report?format=markdown`
- Handlerï¼š`internal/api/http/forensics_query.go`

**3. æŠ¥å‘Šæ¨¡æ¿**ï¼š
- æ–°å»ºï¼š`internal/forensics/report/templates/`
  - `audit_report.md.tmpl`
  - åŒ…å«ï¼štimeline, decisions, evidence, ledger

---

## D. Compliance Controlsï¼ˆ2.4ï¼‰- ç°æœ‰ä»£ç æ˜ å°„

### D1. RBAC / Tenant / Namespace

#### âœ… å·²æœ‰æ¡†æ¶

**æƒé™æ¨¡å‹**ï¼š
- `pkg/auth/rbac.go` - Permission, Role, RBACChecker æ¥å£
- `pkg/auth/tenant.go` - Tenant æ¨¡å‹
- `pkg/auth/context.go` - Context helpers

**æ•°æ®åº“**ï¼š
- `internal/runtime/jobstore/schema.sql:47-77` - tenants, user_roles, access_audit_log è¡¨

**Middleware**ï¼š
- `internal/api/http/middleware/authz.go` - AuthZMiddleware
- `internal/api/http/middleware/audit.go` - AuditMiddleware

#### ğŸ”§ éœ€è¦è¡¥å……

**1. JWT é›†æˆ**ï¼š
- ä¿®æ”¹ï¼š`internal/api/http/middleware/middleware.go`
  - ä» JWT æå– tenant_id å’Œ user_id
  - æ³¨å…¥åˆ° context

**2. API Handler é›†æˆ**ï¼š
- ä¿®æ”¹ï¼šæ‰€æœ‰ `internal/api/http/*.go` handlers
  - æ·»åŠ  tenant è¿‡æ»¤ï¼š`WHERE tenant_id = auth.GetTenantID(ctx)`
  - Job åˆ›å»ºæ—¶ç»‘å®š tenant_id

**3. è·¯ç”±ä¿æŠ¤**ï¼š
- ä¿®æ”¹ï¼š`internal/api/http/router.go`
  - æ•æ„Ÿ API æ·»åŠ  `authz.RequirePermission()`

---

### D2. Redaction Policyï¼ˆè„±æ•ï¼‰

#### âœ… å·²æœ‰æ¡†æ¶

**è„±æ•å¼•æ“**ï¼š
- `pkg/redaction/engine.go` - `Engine.RedactData()` å®ç°
- `pkg/redaction/policy.go` - RedactionPolicy æ•°æ®ç»“æ„

**ExportOptions**ï¼š
- `pkg/proof/types.go:85-91` - å·²æœ‰ `RedactionEnabled` å’Œ `RedactionSalt`

#### ğŸ”§ éœ€è¦è¡¥å……

**1. å¯¼å‡ºé›†æˆ**ï¼š
- ä¿®æ”¹ï¼š`pkg/proof/export.go:ExportEvidenceZip()`
- åœ¨åºåˆ—åŒ–å‰ï¼š
```go
if opts.RedactionEnabled {
    engine := redaction.NewEngine(policy, nil)
    for i := range events {
        events[i].Payload, _ = engine.RedactData(events[i].Type, events[i].Payload)
    }
}
```

**2. é…ç½®åŠ è½½**ï¼š
- ä¿®æ”¹ï¼š`configs/api.yaml`
```yaml
redaction:
  enable: true
  policies:
    - event_type: "llm_called"
      fields:
        - path: "payload.prompt"
          mode: "hash"
```

---

### D3. Audit Access Log

#### âœ… å·²æœ‰æ¡†æ¶

**äº‹ä»¶ç±»å‹**ï¼š
- `internal/runtime/jobstore/event.go:84-86` - M2 å·²æ·»åŠ ï¼š
  - `AccessAudited`

**Middleware**ï¼š
- `internal/api/http/middleware/audit.go` - AuditMiddleware
- å¼‚æ­¥è®°å½•è®¿é—®

#### ğŸ”§ éœ€è¦è¡¥å……

**1. å¯¼å‡ºå®¡è®¡äº‹ä»¶**ï¼š
- ä¿®æ”¹ï¼š`internal/api/http/forensics.go:ExportJobForensics()`
- å¼€å§‹æ—¶å†™ï¼š`evidence_export_requested` äº‹ä»¶
- å®Œæˆæ—¶å†™ï¼š`evidence_export_completed` äº‹ä»¶ï¼ˆå« zip_sha256ï¼‰

**2. äº‹ä»¶ç±»å‹æ·»åŠ **ï¼ˆM4 å·²éƒ¨åˆ†æ·»åŠ ï¼‰ï¼š
```go
// internal/runtime/jobstore/event.go
const (
    EvidenceExportRequested EventType = "evidence_export_requested"
    EvidenceExportCompleted EventType = "evidence_export_completed"
)
```

---

### D4. Retention / Tombstone

#### âœ… å·²æœ‰æ¡†æ¶

**Retention Engine**ï¼š
- `pkg/retention/engine.go` - `ArchiveJob()`, `DeleteJob()` æ¡†æ¶
- `pkg/retention/policy.go` - RetentionPolicy é…ç½®

**æ•°æ®åº“**ï¼š
- `internal/runtime/jobstore/schema.sql:118-128` - `job_tombstones` è¡¨

**äº‹ä»¶ç±»å‹**ï¼š
- `internal/runtime/jobstore/event.go:82-84` - `JobArchived`, `JobDeleted`

#### ğŸ”§ éœ€è¦è¡¥å……

**1. Worker å®šæ—¶ä»»åŠ¡**ï¼š
- ä¿®æ”¹ï¼š`internal/app/worker/app.go`
- å¯åŠ¨ goroutineï¼š
```go
if cfg.Retention.Enable {
    go func() {
        ticker := time.NewTicker(cfg.Retention.ScanInterval)
        for range ticker.C {
            retentionEngine.RunRetentionScan(ctx)
        }
    }()
}
```

**2. Retention Engine å®ç°**ï¼š
- ä¿®æ”¹ï¼š`pkg/retention/engine.go:RunRetentionScan()`
- æŸ¥è¯¢è¿‡æœŸ jobs â†’ ArchiveJob â†’ DeleteJob â†’ CreateTombstone

---

## E. Storage Lifecycleï¼ˆ2.5ï¼‰- ç°æœ‰ä»£ç æ˜ å°„

### E1. Event Compaction

#### âœ… å·²æœ‰æ¡†æ¶

**Snapshot**ï¼š
- `internal/runtime/jobstore/snapshot.go` - Snapshot æ•°æ®ç»“æ„
- `internal/runtime/jobstore/store.go:74-80` - Snapshot æ¥å£
- `internal/runtime/jobstore/pgstore.go:353-398` - PG å®ç°
- `internal/runtime/jobstore/schema.sql:184-192` - `job_snapshots` è¡¨

**ReplayContext Builder**ï¼š
- `internal/agent/replay/replay.go:347-449` - `BuildFromSnapshot()`
  - åŠ è½½ snapshot + å¢é‡äº‹ä»¶

#### ğŸ”§ éœ€è¦è¡¥å……

**1. Snapshot è‡ªåŠ¨åˆ›å»º**ï¼š
- ä¿®æ”¹ï¼š`internal/app/worker/app.go`
- Worker å®šæ—¶ä»»åŠ¡ï¼š
```go
go func() {
    ticker := time.NewTicker(1 * time.Hour)
    for range ticker.C {
        // æ‰«æäº‹ä»¶æ•° > 1000 çš„ jobs
        // è°ƒç”¨ jobstore.CreateSnapshot()
    }
}()
```

**2. Compaction ç­–ç•¥**ï¼š
- æ–°å»ºï¼š`internal/compaction/strategy.go`
  - `ShouldCompact(job_id, event_count) bool`
  - å¯é…ç½®ï¼štime_threshold, event_threshold

---

### E2. Archive/Restore

#### ğŸ†• éœ€è¦æ–°å¢

**1. Archive Backend**ï¼š
- æ–°å»ºï¼š`pkg/archive/backend.go`
  - `type ArchiveBackend interface { Upload, Download, List }`
  - å®ç°ï¼šLocal, S3, GCS

**2. Archive Service**ï¼š
- æ–°å»ºï¼š`internal/archive/service.go`
  - `ArchiveJob(jobID) (archiveRef string, error)`
  - å¯¼å‡º evidence.zip â†’ ä¸Šä¼ åˆ° backend â†’ è¿”å› URI

**3. Restore Service**ï¼š
- æ–°å»ºï¼š`internal/archive/restore.go`
  - `RestoreJob(archiveRef) error`
  - ä¸‹è½½ evidence.zip â†’ éªŒè¯ â†’ é‡æ–°å¯¼å…¥äº‹ä»¶ï¼ˆå¯é€‰ï¼‰

---

## ä»£ç ç»„ç»‡å»ºè®®

### å½“å‰ç»“æ„ï¼ˆå·²éªŒè¯è‰¯å¥½ï¼‰

```
pkg/
â”œâ”€â”€ proof/              âœ… Evidence export & verify (å®Œæ•´)
â”œâ”€â”€ auth/               âœ… RBAC model (å®Œæ•´)
â”œâ”€â”€ redaction/          âœ… Redaction engine (å®Œæ•´)
â”œâ”€â”€ retention/          âœ… Retention policy (æ¡†æ¶)
â”œâ”€â”€ evidence/           âœ… Evidence Graph builder (æ¡†æ¶)
â”œâ”€â”€ forensics/          âœ… Query types (æ¡†æ¶)
â”œâ”€â”€ signature/          ğŸ”¬ Ed25519 (3.0 prototype)
â”œâ”€â”€ distributed/        ğŸ”¬ Sync protocol (3.0 prototype)
â”œâ”€â”€ ai_forensics/       ğŸ”¬ AI detection (3.0 prototype)
â”œâ”€â”€ monitoring/         ğŸ”¬ Quality scorer (3.0 prototype)
â””â”€â”€ compliance/         ğŸ”¬ Templates (3.0 prototype)

internal/
â”œâ”€â”€ api/http/
â”‚   â”œâ”€â”€ forensics.go      âœ… Export handler (å®Œæ•´)
â”‚   â”œâ”€â”€ forensics_query.go âœ… Query handlers (æ¡†æ¶)
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ authz.go      âœ… AuthZ (æ¡†æ¶)
â”‚       â””â”€â”€ audit.go      âœ… Audit (æ¡†æ¶)
â”œâ”€â”€ agent/runtime/executor/
â”‚   â”œâ”€â”€ invocation_store.go âœ… Store interface (æ‰©å±•å®Œæˆ)
â”‚   â”œâ”€â”€ invocation_pg.go    âœ… PG impl (ListByJobID å®Œæˆ)
â”‚   â””â”€â”€ node_adapter.go     âœ… Rate limiter é›†æˆå®Œæˆ
â””â”€â”€ runtime/jobstore/
    â”œâ”€â”€ snapshot.go     âœ… Snapshot types (å®Œæ•´)
    â”œâ”€â”€ pgstore.go      âœ… Snapshot methods (å®Œæ•´)
    â””â”€â”€ schema.sql      âœ… æ‰€æœ‰è¡¨å®šä¹‰ (å®Œæ•´)
```

### 2.x å»ºè®®æ–°å¢

```
pkg/
â”œâ”€â”€ artifacts/          ğŸ†• 2.2: Artifact store
â””â”€â”€ archive/            ğŸ†• 2.5: Archive backend

internal/
â”œâ”€â”€ evidence/
â”‚   â”œâ”€â”€ exporter/       ğŸ†• 2.1: æŠ½è±¡å¯¼å‡ºé€»è¾‘
â”‚   â””â”€â”€ consistency/    ğŸ†• 2.1: ä¸€è‡´æ€§æ ¡éªŒ
â”œâ”€â”€ forensics/
â”‚   â”œâ”€â”€ query/          ğŸ†• 2.3: Query engine impl
â”‚   â”œâ”€â”€ report/         ğŸ†• 2.3: Report generator
â”‚   â””â”€â”€ export_task/    ğŸ†• 2.3: æ‰¹é‡å¯¼å‡ºä»»åŠ¡
â”œâ”€â”€ indexer/            ğŸ†• 2.3: Job indexer
â”œâ”€â”€ compaction/         ğŸ†• 2.5: Compaction strategy
â””â”€â”€ archive/            ğŸ†• 2.5: Archive service

design/
â””â”€â”€ evidence-package-schema.md  ğŸ†• 2.1: æŠ€æœ¯è§„èŒƒ
```

---

## 2.x å®æ–½ä¼˜å…ˆçº§ï¼ˆæŒ‰ CTO æ‹†è§£ï¼‰

### 2.1 (å½“å‰ï¼Œ4 å‘¨)

**Core**:
- [x] PR#1: Ledger ListByJobID() - âœ… å·²å®Œæˆ
- [ ] PR#2: CLI verify å®Œæ•´ - è®¾è®¡å®Œæˆï¼Œå¾…å®ç°
- [ ] PR#3: æµå¼å¯¼å‡º - è®¾è®¡å®Œæˆï¼Œå¾…å®ç°
- [ ] PR#4: å®¡è®¡æ—¥å¿— - è®¾è®¡å®Œæˆï¼Œå¾…å®ç°

**Polish**:
- [ ] PR#5: é…ç½®ç®¡ç†
- [ ] PR#6: Ledger ä¸¥æ ¼æ ¡éªŒ
- [ ] PR#7-8: æ–‡æ¡£
- [ ] PR#9-10: AuthZ + æµ‹è¯•

**Gate**: Export å¯ç”¨ + Verify å¿…è¿‡ + Ledger ä¸€è‡´æ€§

### 2.2 (Q2, 4-6 å‘¨)

- Artifact store (è¡¨ + æ¥å£ + Runner é›†æˆ)
- Evidence Graph (æ¨å¯¼æ¨¡å¼ï¼Œä¸å»ºè¡¨)
- Decision markers (äº‹ä»¶ + æ¥å£)

**Gate**: Graph æ„å»ºç¨³å®š + Artifacts å¯æŸ¥

### 2.3 (Q3, 4-6 å‘¨)

- Job indexer (è¡¨æ‰©å±• + æ›´æ–°é€»è¾‘)
- Query engine å®ç°
- æ‰¹é‡å¯¼å‡ºä»»åŠ¡é˜Ÿåˆ—
- Report generator

**Gate**: Query æ”¯æŒ 3 ç§è¿‡æ»¤ + æ‰¹é‡å¯¼å‡ºå¼‚æ­¥

### 2.4-2.5 (Q4, 6-8 å‘¨)

- RBAC å®Œæ•´é›†æˆ
- Redaction åº”ç”¨
- Retention è‡ªåŠ¨åŒ–
- Compaction + Archive

---

## å…³é”®å†³ç­–ç‚¹

### 1. Evidence Graph å­˜å‚¨ç­–ç•¥

**é€‰é¡¹ A**ï¼ˆæ¨èï¼‰: æ¨å¯¼æ¨¡å¼
- ä» events + reasoning_snapshot æ¨å¯¼
- ä¸å»º `causal_edges` è¡¨
- å®æ—¶æ„å»ºï¼ˆç¼“å­˜ç»“æœï¼‰

**é€‰é¡¹ B**: å­˜å‚¨æ¨¡å¼
- å»º `causal_edges` è¡¨
- Runner å†™å…¥è¾¹
- æŸ¥è¯¢æ›´å¿«ä½†å­˜å‚¨å¤§

**å»ºè®®**: 2.2 å…ˆç”¨æ¨å¯¼æ¨¡å¼ï¼Œæ€§èƒ½ä¸å¤Ÿå†è€ƒè™‘å­˜å‚¨

### 2. Artifact å­˜å‚¨ç²’åº¦

**é€‰é¡¹ A**ï¼ˆæ¨èï¼‰: è½»é‡çº§
- åªå­˜ hash + metadata
- payload ä¸å­˜ï¼ˆä» events è·å–ï¼‰

**é€‰é¡¹ B**: å®Œæ•´å­˜å‚¨
- å­˜å®Œæ•´ payload
- ä¾¿äºæŸ¥è¯¢ä½†å­˜å‚¨å¤§

**å»ºè®®**: 2.2 å…ˆè½»é‡çº§ï¼Œ3.0 å†è€ƒè™‘å®Œæ•´å­˜å‚¨

### 3. Job Index æ›´æ–°æ—¶æœº

**é€‰é¡¹ A**: åŒæ­¥æ›´æ–°
- Append äº‹ä»¶æ—¶åŒæ­¥æ›´æ–° index
- å¼ºä¸€è‡´ä½†æ€§èƒ½å½±å“å¤§

**é€‰é¡¹ B**ï¼ˆæ¨èï¼‰: å¼‚æ­¥æ›´æ–°
- åå° indexer æ¶ˆè´¹äº‹ä»¶æµ
- æœ€ç»ˆä¸€è‡´æ€§

**å»ºè®®**: 2.3 ç”¨å¼‚æ­¥ï¼Œæ€§èƒ½æ›´å¥½

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

åŸºäºä½ çš„ CTO æ‹†è§£å’Œç°æœ‰ä»£ç ï¼Œæˆ‘å»ºè®®ï¼š

**ç«‹å³ï¼ˆæœ¬å‘¨ï¼‰**:
1. è¡¥å…… PR#2-4 çš„å®ç°ï¼ˆCLI verify, æµå¼å¯¼å‡º, å®¡è®¡æ—¥å¿—ï¼‰
2. æ·»åŠ  2.1 é›†æˆæµ‹è¯•
3. æ–‡æ¡£è¡¥å……

**è¿‘æœŸï¼ˆ2-4 å‘¨ï¼Œ2.1 å®Œæˆï¼‰**:
4. PR#5-10 è¡¥å……å®Œæ•´
5. æ€§èƒ½æµ‹è¯•
6. ç”Ÿäº§ç¯å¢ƒéªŒè¯

**ä¸­æœŸï¼ˆQ2ï¼Œ2.2 å¯åŠ¨ï¼‰**:
- Artifact store è®¾è®¡ä¸å®ç°
- Evidence Graph æ¨å¯¼æ¨¡å¼å®Œå–„
- Decision markers é›†æˆ

è¿™ä»½ mapping å°† CTO çº§æ‹†è§£ç²¾ç¡®å¯¹åº”åˆ°äº†ä½ ç°æœ‰çš„ 79 ä¸ªæ–‡ä»¶å’Œ 10200+ è¡Œä»£ç ä¸Šï¼Œé¿å…é‡å¤ï¼Œæ‰¾åˆ°çœŸæ­£çš„é›†æˆç‚¹ã€‚

å‡†å¤‡å¥½å¼€å§‹å®æ–½äº†å—ï¼Ÿ
